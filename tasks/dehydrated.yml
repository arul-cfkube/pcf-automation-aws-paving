---
platform: linux
image_resource:
  type: docker-image
  source:
    repository: voor/dehydrated-route53
    tag: latest
inputs:
  - name: certificates

params:
  AWS_ACCESS_KEY_ID:
  AWS_SECRET_ACCESS_KEY:
  ENV_NAME:
  DNS_SUFFIX:
run:
  path: /bin/sh
  dir: 
  args:
    - -c
    - |
        set -euxo pipefail

        mkdir -p certificates/${ENV_NAME}.${DNS_SUFFIX}/{chains,certs,accounts}

        echo "${ENV_NAME}.${DNS_SUFFIX} *.${ENV_NAME}.${DNS_SUFFIX} *.pks.${ENV_NAME}.${DNS_SUFFIX} > domain" > domains.txt

        export DOMAINS_TXT="$PWD/domains.txt"
        export CHALLENGETYPE="dns-01"
        export HOOK="./hook.sh"
        export HOOK_CHAIN="no"
        export LOCKFILE="/tmp/lock"
        export CHAINCACHE="${PWD}/certificates/${ENV_NAME}.${DNS_SUFFIX}/chains"
        export CERTDIR="${PWD}/certificates/${ENV_NAME}.${DNS_SUFFIX}/certs"
        export ACCOUNTDIR="${PWD}/certificates/${ENV_NAME}.${DNS_SUFFIX}/accounts"

        /home/dehydrated/dehydrated --accept-terms -c

        tar cvfz certificates/certificates.tgz certificates/${ENV_NAME}.${DNS_SUFFIX}/