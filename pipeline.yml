---
resource_types:
  - name: terraform
    type: docker-image
    source:
      repository: ljfranklin/terraform-resource
      tags: latest

  - name: pivnet
    type: docker-image
    source:
      repository: pivotalcf/pivnet-resource
      tags: latest-final

resources:
  - name: platform-automation-pivnet
    type: pivnet
    source:
      api_token: ((pivnet-api-token))
      product_slug: platform-automation
      product_version: ((platform-automation-version))
      sort_by: semver

  - name: env-state-aws
    type: terraform
    source:
      backend_type: s3
      backend_config:
        bucket: ((buckets.installation))
        key: terraform.tfstate
      vars:
        env_name: ((pcf.env_name))
        dns_suffix: ((terraform.aws.dns_suffix))
        hosted_zone: ((terraform.aws.hosted_zone))
        region: ((region))
        availability_zones: ((terraform.aws.availability_zones))
        rds_instance_count: ((terraform.aws.rds_instance_count))

        ops_manager_vm: false
      env:
        AWS_ACCESS_KEY_ID: ((access_key_id))
        AWS_SECRET_ACCESS_KEY: ((secret_access_key))
        AWS_DEFAULT_REGION: ((region))

  # buckets

  - name: platform-automation-tasks
    type: s3
    source:
      bucket: ((buckets.pivnet_products))
      access_key_id: ((access_key_id))
      secret_access_key: ((secret_access_key))
      region_name: ((region))
      regexp: platform-automation-tasks-((platform-automation-version)).zip

  - name: platform-automation-image
    type: s3
    source:
      bucket: ((buckets.pivnet_products))
      access_key_id: ((access_key_id))
      secret_access_key: ((secret_access_key))
      region_name: ((region))
      regexp: platform-automation-image-((platform-automation-version)).tgz

  - name: opsman-image
    type: s3
    source:
      bucket: ((buckets.pivnet_products))
      access_key_id: ((access_key_id))
      secret_access_key: ((secret_access_key))
      region_name: ((region))
      regexp: ops-manager-aws-(.*).yml

  - name: pks-product
    type: s3
    source:
      bucket: ((buckets.pivnet_products))
      access_key_id: ((access_key_id))
      secret_access_key: ((secret_access_key))
      region_name: ((region))
      regexp: pivotal-container-service-(.*).pivotal

  - name: pks-stemcell
    type: s3
    source:
      bucket: ((buckets.pivnet_products))
      access_key_id: ((access_key_id))
      secret_access_key: ((secret_access_key))
      region_name: ((region))
      regexp: pks-stemcell/light-bosh-stemcell-(.*)-aws.*\.tgz #light-bosh-stemcell-170.15-aws-xen-hvm-ubuntu-xenial-go_agent.tgz

  - name: installation
    type: s3
    source:
      bucket: ((buckets.installation))
      access_key_id: ((access_key_id))
      secret_access_key: ((secret_access_key))
      region_name: ((region))
      versioned_file: ((pcf.env_name))/installation.zip

  - name: certificates
    type: s3
    source:
      bucket: ((buckets.installation))
      access_key_id: ((access_key_id))
      secret_access_key: ((secret_access_key))
      region_name: ((region))
      versioned_file: ((pcf.env_name))/certificates.tgz
      initial_version: 0.0.0

  # configurations
  - name: pcf-automation-source
    type: git
    source:
      uri: ((github.repos.pcf-automation-source.uri))
      branch: ((github.repos.pcf-automation-source.branch))

  - name: terraforming-aws
    type: git
    source:
      uri: ((github.repos.terraforming-aws.uri))
      branch: ((github.repos.terraforming-aws.branch))

  - name: configuration
    type: git
    source:
      private_key: ((pcf-config_deploy_rsa.private_key))
      uri: ((github.repos.configuration.uri))
      branch: master

  # triggers used to have jobs do something in a timely manner

  - name: one-time-trigger
    type: time
    source:
      interval: 999999h

  - name: daily-trigger
    type: time
    source:
      interval: 24h

interpolate: &interpolate
  file: pcf-automation-source/tasks/interpolate.yml
  input_mapping:
    config: configuration
    terraform-output: env-state-aws
    certificates: certificates
  output_mapping:
    interpolated-config: configuration-interpolated
  params:
    ENV_NAME: ((pcf.env_name))
    PIVNET_API_TOKEN: ((pivnet-api-token))
    AWS_ACCESS_KEY_ID: ((access_key_id))
    AWS_SECRET_ACCESS_KEY: ((secret_access_key))
    OM_USERNAME: ((opsman.username))
    OM_PASSWORD: ((opsman_password))
    OM_DECRYPTION_PASSPHRASE: ((opsman_decryption-passphrase))

make-state-commit: &make-state-commit
  do:
    - task: make-commit
      image: platform-automation-image
      file: platform-automation-tasks/tasks/make-git-commit.yml
      input_mapping:
        repository: configuration
        file-source: generated-state
      output_mapping:
        repository-commit: configuration-commit
      params:
        FILE_SOURCE_PATH: state.yml
        FILE_DESTINATION_PATH: ((pcf.env_name))/state/state.yml
        GIT_AUTHOR_EMAIL: ((pcf.pipeline_email))
        GIT_AUTHOR_NAME: ((pcf.pipeline_name))
        COMMIT_MESSAGE: "Update state file"
    - put: configuration
      params:
        repository: configuration-commit
        merge: true

jobs:
  - name: letsencrypt-certificates
    serial: true
    public: false
    plan:
      - aggregate:
          - get: pcf-automation-source
            trigger: true
          - get: certificates
            params:
              unpack: true
          - get: daily-trigger
            trigger: true
      - task: dehydrated
        file: pcf-automation-source/tasks/dehydrated.yml
        input_mapping:
          certificates: certificates
        output_mapping:
          certificates: updated-certificates
        params:
          AWS_ACCESS_KEY_ID: ((access_key_id))
          AWS_SECRET_ACCESS_KEY: ((secret_access_key))
          ENV_NAME: ((pcf.env_name))
          DNS_SUFFIX: ((terraform.aws.dns_suffix))
      - put: certificates
        params:
          file: updated-certificates/certificates*.tgz

  - name: terraforming-aws
    serial: true
    public: false
    plan:
      - get: terraforming-aws
        trigger: true
      - put: env-state-aws
        params:
          env_name: ((pcf.env_name))
          terraform_source: terraforming-aws/terraforming-pks
          delete_on_failure: false

  - name: configuration
    serial: true
    public: false
    plan:
      - aggregate:
          - get: pcf-automation-source
            trigger: true
          - get: configuration
          - get: env-state-aws
            passed: [terraforming-aws]
          - get: certificates
            params:
              unpack: true
            passed: [letsencrypt-certificates]
      - task: add-new-templates
        input_mapping:
          config: configuration
          pcf-automation: pcf-automation-source
        params:
          ENV_NAME: ((pcf.env_name))
          GIT_AUTHOR_EMAIL: ((pcf.pipeline_email))
          GIT_AUTHOR_NAME: ((pcf.pipeline_name))
          COMMIT_MESSAGE: "Update template files"
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: alpine/git
          inputs:
            - name: config
            - name: pcf-automation
          outputs:
            - name: config-commit
          run:
            path: /bin/sh
            args:
              - -c
              - |
                set -eux
                git clone config config-commit
                mkdir -p config-commit/$ENV_NAME/state
                touch config-commit/$ENV_NAME/state/state.yml
                cp -a pcf-automation/templates/* config-commit/$ENV_NAME
                git config --global user.email "$GIT_AUTHOR_EMAIL"
                git config --global user.name "$GIT_AUTHOR_NAME"
                cd config-commit
                git add -A
                git diff-index --quiet HEAD || git commit -m "$COMMIT_MESSAGE"
      - put: configuration
        params:
          repository: config-commit
          merge: true

  - name: fetch-platform-automation
    # We use the pivnet resource to bootstrap the pipeline,
    # and because this product is part of the pipeline, not the foundation
    plan:
      - get: platform-automation-pivnet
        trigger: true
      - aggregate:
          - put: platform-automation-tasks
            params:
              file: platform-automation-pivnet/*tasks*.zip
          - put: platform-automation-image
            params:
              file: platform-automation-pivnet/*image*.tgz

  ### FETCH JOBS
  - name: fetch-opsman
    serial: true
    public: false
    plan:
      - aggregate:
          - get: platform-automation-image
            params:
              unpack: true
          - get: platform-automation-tasks
            params:
              unpack: true
          - get: configuration
            passed: [configuration]
          - get: pcf-automation-source
          - get: env-state-aws
          - get: daily-trigger
            trigger: true
      - task: interpolate-config
        <<: *interpolate
      - task: download-opsman-image
        image: platform-automation-image
        file: platform-automation-tasks/tasks/download-product.yml
        params:
          CONFIG_FILE: ((pcf.env_name))/download-product-configs/opsman.yml
          VARS_FILES: config/((pcf.env_name))/download-product-configs/vars.yml
        input_mapping:
          config: configuration-interpolated
      - aggregate:
          - put: opsman-image
            params:
              file: downloaded-product/*

  - name: fetch-pks
    plan:
      - aggregate:
          - get: platform-automation-image
            params:
              unpack: true
          - get: platform-automation-tasks
            params:
              unpack: true
          - get: configuration
            passed: [configuration]
          - get: pcf-automation-source
          - get: env-state-aws
          - get: daily-trigger
            trigger: true
      - task: interpolate-config
        <<: *interpolate
      - task: download-pks-product-and-stemcell
        image: platform-automation-image
        file: platform-automation-tasks/tasks/download-product.yml
        params:
          CONFIG_FILE: ((pcf.env_name))/download-product-configs/pks.yml
          VARS_FILES: config/((pcf.env_name))/download-product-configs/vars.yml
        input_mapping:
          config: configuration-interpolated
        output_mapping:
          downloaded-stemcell: pks-stemcell
      - aggregate:
          - put: pks-product
            params:
              file: downloaded-product/*.pivotal
          - put: pks-stemcell
            params:
              file: pks-stemcell/*.tgz

  # INSTALL JOBS

  - name: install-opsman
    serial: true
    serial_groups: [install]
    plan:
      - aggregate:
          - get: platform-automation-image
            params:
              unpack: true
          - get: one-time-trigger
            trigger: true
          - get: platform-automation-tasks
            params:
              unpack: true
          - get: certificates
            params:
              unpack: true
            passed: [letsencrypt-certificates]
          - get: opsman-image
            passed: [fetch-opsman]
          - get: configuration
          - get: pcf-automation-source
          - get: env-state-aws
      - task: interpolate-config
        <<: *interpolate
      - task: create-vm
        image: platform-automation-image
        file: platform-automation-tasks/tasks/create-vm.yml
        input_mapping:
          image: opsman-image
          state: configuration
          config: configuration-interpolated
        params:
          STATE_FILE: ((pcf.env_name))/state/state.yml
          OPSMAN_CONFIG_FILE: ((pcf.env_name))/config/opsman.yml
        ensure: *make-state-commit
      - task: configure-authentication
        image: platform-automation-image
        file: platform-automation-tasks/tasks/configure-authentication.yml
        attempts: 10
        input_mapping:
          env: configuration-interpolated
          config: configuration-interpolated
        params:
          ENV_FILE: ((pcf.env_name))/env/env.yml
          AUTH_CONFIG_FILE: ((pcf.env_name))/config/auth.yml
      - task: configure-director-ssl
        image: platform-automation-image
        file: pcf-automation-source/tasks/configure-director-ssl.yml
        input_mapping:
          config: configuration-interpolated
          env: configuration-interpolated
        params:
          ENV_FILE: ((pcf.env_name))/env/env.yml
          CERTIFICATE_PEM: ((pcf.env_name))/config/ops_manager_fullchain.pem
          PRIVATE_KEY_PEM: ((pcf.env_name))/config/ops_manager_privkey.pem
      - task: configure-director
        image: platform-automation-image
        file: platform-automation-tasks/tasks/configure-director.yml
        input_mapping:
          config: configuration-interpolated
          env: configuration-interpolated
        params:
          ENV_FILE: ((pcf.env_name))/env/env.yml
          DIRECTOR_CONFIG_FILE: ((pcf.env_name))/config/director.yml
      - task: apply-director-changes
        image: platform-automation-image
        file: platform-automation-tasks/tasks/apply-director-changes.yml
        input_mapping:
          env: configuration-interpolated
        params:
          ENV_FILE: ((pcf.env_name))/env/env.yml
  # UPGRADE

  - name: export-installation
    serial: true
    plan:
      - aggregate:
          - get: daily-trigger
            trigger: true
          - get: platform-automation-image
            params:
              unpack: true
          - get: platform-automation-tasks
            params:
              unpack: true
          - get: configuration
          - get: pcf-automation-source
          - get: env-state-aws
            passed: [install-opsman]
          - get: certificates
            params:
              unpack: true
            passed: [letsencrypt-certificates]
      - task: interpolate-config
        <<: *interpolate
      - task: export-installation
        image: platform-automation-image
        file: platform-automation-tasks/tasks/export-installation.yml
        input_mapping:
          env: configuration-interpolated
        params:
          ENV_FILE: ((pcf.env_name))/env/env.yml
      - put: installation
        params:
          file: installation/installation-*.zip

  - name: upgrade-opsman
    serial: true
    serial_groups: [install]
    plan:
      - aggregate:
          - get: one-time-trigger
            passed: [install-opsman]
          - get: platform-automation-image
            params:
              unpack: true
          - get: platform-automation-tasks
            params:
              unpack: true
          - get: opsman-image
          - get: installation
            passed: [export-installation]
          - get: configuration
            trigger: true
          - get: pcf-automation-source
          - get: env-state-aws
          - get: certificates
            params:
              unpack: true
            passed: [letsencrypt-certificates]
      - task: interpolate-config
        <<: *interpolate
      - task: upgrade-opsman
        image: platform-automation-image
        file: platform-automation-tasks/tasks/upgrade-opsman.yml
        input_mapping:
          image: opsman-image
          state: configuration
          config: configuration-interpolated
          env: configuration-interpolated
          vars: configuration-interpolated
        params:
          ENV_FILE: ((pcf.env_name))/env/env.yml
          STATE_FILE: ((pcf.env_name))/state/state.yml
          OPSMAN_CONFIG_FILE: ((pcf.env_name))/config/opsman.yml
        ensure: *make-state-commit
      - task: apply-director-changes
        image: platform-automation-image
        file: platform-automation-tasks/tasks/apply-director-changes.yml
        input_mapping:
          env: configuration-interpolated
        params:
          ENV_FILE: ((pcf.env_name))/env/env.yml

  - name: upload-and-stage-product
    serial: true
    plan:
      - aggregate:
          - get: platform-automation-image
            params:
              unpack: true
          - get: platform-automation-tasks
            params:
              unpack: true
          - get: pks-product
            trigger: true
          - get: configuration
            passed:
              - upgrade-opsman
            trigger: true
          - get: pcf-automation-source
          - get: env-state-aws
          - get: certificates
            params:
              unpack: true
            passed: [letsencrypt-certificates]
      - task: interpolate-config
        <<: *interpolate
      - task: upload-product
        image: platform-automation-image
        file: platform-automation-tasks/tasks/upload-product.yml
        input_mapping:
          product: pks-product
          env: configuration-interpolated
        params:
          ENV_FILE: ((pcf.env_name))/env/env.yml
      - task: stage-product
        image: platform-automation-image
        file: platform-automation-tasks/tasks/stage-product.yml
        input_mapping:
          product: pks-product
          env: configuration-interpolated
        params:
          ENV_FILE: ((pcf.env_name))/env/env.yml

  - name: upload-stemcell
    serial: true
    plan:
      - aggregate:
          - get: platform-automation-image
            params:
              unpack: true
          - get: platform-automation-tasks
            params:
              unpack: true
          - get: pks-stemcell
            trigger: true
          - get: configuration
            passed:
              - upgrade-opsman
            trigger: true
          - get: pcf-automation-source
          - get: env-state-aws
          - get: certificates
            params:
              unpack: true
            passed: [letsencrypt-certificates]
      - task: interpolate-config
        <<: *interpolate
      - task: upload-pks-stemcell
        image: platform-automation-image
        file: platform-automation-tasks/tasks/upload-stemcell.yml
        input_mapping:
          env: configuration-interpolated
          stemcell: pks-stemcell
        params:
          ENV_FILE: ((pcf.env_name))/env/env.yml

  - name: configure-product
    serial: true
    plan:
      - aggregate:
          - get: platform-automation-image
            params:
              unpack: true
            passed:
              - upload-and-stage-product
            trigger: true
          - get: platform-automation-tasks
            params:
              unpack: true
          - get: configuration
          - get: pcf-automation-source
          - get: env-state-aws
          - get: certificates
            params:
              unpack: true
            passed: [letsencrypt-certificates]
      - task: interpolate-config
        <<: *interpolate
      - task: configure-product
        image: platform-automation-image
        file: platform-automation-tasks/tasks/configure-product.yml
        input_mapping:
          config: configuration-interpolated
          env: configuration-interpolated
        params:
          CONFIG_FILE: ((pcf.env_name))/config/pks.yml
          ENV_FILE: ((pcf.env_name))/env/env.yml

  - name: apply-product-changes
    serial: true
    plan:
      - aggregate:
          - get: platform-automation-image
            params:
              unpack: true
            passed:
              - configure-product
            trigger: true
          - get: platform-automation-tasks
            params:
              unpack: true
          - get: configuration
          - get: pcf-automation-source
          - get: env-state-aws
          - get: certificates
            params:
              unpack: true
            passed: [letsencrypt-certificates]
      - task: interpolate-config
        <<: *interpolate
      - task: apply-product-changes
        image: platform-automation-image
        file: platform-automation-tasks/tasks/apply-changes.yml
        input_mapping:
          env: configuration-interpolated
        params:
          ENV_FILE: ((pcf.env_name))/env/env.yml

  - name: destroy-installation
    serial: true
    public: false
    plan:
      - aggregate:
          - get: env-state-aws
          - get: pcf-automation-source
            trigger: false
          - get: platform-automation-image
            params:
              unpack: true
          - get: platform-automation-tasks
            params:
              unpack: true
          - get: configuration
          - get: certificates
            params:
              unpack: true
            passed: [letsencrypt-certificates]
      - task: interpolate-config
        <<: *interpolate
      - try:
          task: delete-installation
          image: platform-automation-image
          file: platform-automation-tasks/tasks/delete-installation.yml
          input_mapping:
            env: configuration-interpolated
          params:
            ENV_FILE: ((pcf.env_name))/env/env.yml
      - task: delete-vm
        image: platform-automation-image
        file: platform-automation-tasks/tasks/delete-vm.yml
        input_mapping:
          state: configuration
          config: configuration-interpolated
        params:
          STATE_FILE: ((pcf.env_name))/state/state.yml
          OPSMAN_CONFIG_FILE: ((pcf.env_name))/config/opsman.yml

  - name: destroy-terraform
    serial: true
    public: false
    plan:
      - aggregate:
          - get: terraforming-aws
            trigger: false
          - get: configuration
          - get: env-state-aws
            passed: [destroy-installation]
      - put: env-state-aws
        params:
          terraform_source: terraforming-aws/terraforming-pks
          delete_on_failure: true
          env_name: ((pcf.env_name))
          action: destroy
        get_params:
          action: destroy
      - task: delete-config
        input_mapping:
          config: configuration
        params:
          ENV_NAME: ((pcf.env_name))
          GIT_AUTHOR_EMAIL: ((pcf.pipeline_email))
          GIT_AUTHOR_NAME: ((pcf.pipeline_name))
          COMMIT_MESSAGE: "Delete Environment"
        config:
          platform: linux
          image_resource:
            type: docker-image
            source:
              repository: alpine/git
          inputs:
            - name: config
          outputs:
            - name: config-commit
          run:
            path: /bin/sh
            args:
              - -c
              - |
                set -eux
                git clone config config-commit
                rm -rf config-commit/$ENV_NAME
                git config --global user.email "$GIT_AUTHOR_EMAIL"
                git config --global user.name "$GIT_AUTHOR_NAME"
                cd config-commit
                git add -A
                git diff-index --quiet HEAD || git commit -m "$COMMIT_MESSAGE"
      - put: configuration
        params:
          repository: config-commit
          merge: true

groups:
  - name: prepare
    jobs:
      - letsencrypt-certificates
      - terraforming-aws
      - configuration
      - fetch-platform-automation
  - name: fetch
    jobs:
      - fetch-opsman
      - fetch-pks
  - name: install-platform
    jobs:
      - install-opsman
  - name: upgrade-platform
    jobs:
      - export-installation
      - upgrade-opsman
      - export-installation
  - name: install-product
    jobs:
      - upload-and-stage-product
      - upload-stemcell
      - configure-product
      - apply-product-changes
      - export-installation
  - name: destroy
    jobs:
      - destroy-terraform
      - destroy-installation
